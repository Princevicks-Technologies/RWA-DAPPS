<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Savings Vault — Preprod</title>

  <style>
    :root{
      --navy-900:#06111f;
      --navy-800:#0b1e35;
      --white:#ffffff;
      --soft:#e9eef7;
      --gold:#d7b35a;
      --gold-2:#f2d27c;
      --danger:#ff5f6d;
      --ok:#2fe37f;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.09);
      --line: rgba(255,255,255,0.10);
      --shadow: 0 14px 38px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(215,179,90,0.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 30%, rgba(255,255,255,0.08), transparent 60%),
                  linear-gradient(180deg, var(--navy-900), var(--navy-800));
      color: var(--soft);
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:28px 18px 60px;}
    header{display:flex;gap:18px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:18px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(215,179,90,0.9), rgba(255,255,255,0.22));
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      position:relative;overflow:hidden;
    }
    .logo::after{
      content:"";position:absolute;inset:-30%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.55), transparent);
      transform: rotate(25deg);
      animation: shimmer 4.2s linear infinite;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-40%) rotate(25deg); opacity:0.25;}
      35%{opacity:0.9;}
      100%{ transform: translateX(40%) rotate(25deg); opacity:0.25;}
    }
    h1{margin:0;font-size:18px;letter-spacing:0.4px;color:var(--white);}
    .sub{margin-top:2px;font-size:12.5px;opacity:0.85;}
    .top-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .muted{opacity:0.78}

    .btn{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--white);
      padding: 10px 12px;border-radius: 14px;
      cursor:pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease, filter .2s ease;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.10);
      border-color: rgba(242,210,124,0.55);
      box-shadow: 0 10px 24px rgba(0,0,0,0.26);
      filter: saturate(1.08);
    }
    .btn:active{transform: translateY(0px) scale(0.99);}
    .btn[disabled]{opacity:0.55; cursor:not-allowed; transform:none; box-shadow:none;}
    .btn-primary{
      background: linear-gradient(135deg, rgba(215,179,90,0.95), rgba(255,255,255,0.14));
      border-color: rgba(215,179,90,0.60);
      color: #08121f;font-weight: 700;
    }
    .btn-primary:hover{
      background: linear-gradient(135deg, rgba(242,210,124,1), rgba(255,255,255,0.18));
      border-color: rgba(242,210,124,0.85);
    }
    .btn-danger{
      background: rgba(255,95,109,0.10);
      border-color: rgba(255,95,109,0.35);
      color: #ffd2d6;
    }
    .btn-danger:hover{border-color: rgba(255,95,109,0.65);background: rgba(255,95,109,0.14);}
    .btn-ghost{background: transparent;border-color: rgba(255,255,255,0.12);}

    .connected-pop{
      animation: pop .55s cubic-bezier(.2,.9,.2,1) 1;
      background: linear-gradient(135deg, rgba(47,227,127,0.95), rgba(255,255,255,0.12)) !important;
      border-color: rgba(47,227,127,0.60) !important;
      color: #07121d !important;
      font-weight: 800;
    }
    @keyframes pop{0%{ transform: scale(0.96); opacity: 0.75;}55%{ transform: scale(1.04); opacity:1;}100%{ transform: scale(1.0); opacity:1;}}

    main{display:grid;grid-template-columns: 380px 1fr;gap: 14px;align-items:start;}
    @media (max-width: 980px){ main{grid-template-columns: 1fr;} }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 10px;font-size:14px;letter-spacing:0.4px;color:var(--white);}
    .row{display:flex;gap:10px;align-items:center;}
    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    @media (max-width: 520px){ .grid2{grid-template-columns:1fr;} }
    label{font-size:12px;opacity:0.84;margin-bottom:6px;display:block;}
    input, textarea{
      width:100%;border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--white);
      padding: 10px 12px;
      outline:none;
      transition: border-color .2s ease, background .2s ease;
    }
    input:focus, textarea:focus{border-color: rgba(242,210,124,0.65);background: rgba(255,255,255,0.085);}
    textarea{min-height: 86px;resize:vertical;}

    .vaults-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .vault-list{display:flex;flex-direction:column;gap:12px;}
    .vault{
      background: var(--card2);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 12px;
      transition: transform .15s ease, border-color .2s ease, background .2s ease;
    }
    .vault:hover{transform: translateY(-1px);border-color: rgba(215,179,90,0.34);background: rgba(255,255,255,0.105);}
    .vault-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;}
    .tag{
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
    }
    .tag.gold{border-color: rgba(215,179,90,0.45);color: var(--gold-2);}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top: 8px;align-items:center;}
    .kpi > div{font-size: 12px;opacity:0.9;}
    .progress{margin-top: 10px;height: 12px;background: rgba(0,0,0,0.25);border: 1px solid rgba(255,255,255,0.12);border-radius: 999px;overflow:hidden;}
    .bar{height:100%;width:0%;background: linear-gradient(90deg, rgba(215,179,90,0.95), rgba(255,255,255,0.20));transition: width .35s ease;}
    .vault-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top: 10px;align-items:center;}
    .mini{font-size: 12px;padding: 8px 10px;border-radius: 12px;}
    .copy{cursor:pointer;border: 1px dashed rgba(255,255,255,0.22);padding: 4px 8px;border-radius: 12px;transition: border-color .2s ease, background .2s ease;user-select:none;}
    .copy:hover{border-color: rgba(242,210,124,0.65);background: rgba(255,255,255,0.06);}

    .toast-wrap{position: fixed;right: 14px;bottom: 14px;display:flex;flex-direction:column;gap:10px;z-index: 9999;}
    .toast{
      width: min(600px, calc(100vw - 28px));
      background: rgba(6,17,31,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: slideIn .22s ease both;
    }
    @keyframes slideIn{from{ transform: translateY(10px); opacity:0;}to{ transform: translateY(0); opacity:1;}}
    .toast .t-title{font-weight:800;color:var(--white);font-size: 13px;}
    .toast .t-msg{font-size: 12.5px;opacity:0.9;margin-top:6px;line-height:1.25rem;white-space:pre-wrap;}
    .toast.ok{border-color: rgba(47,227,127,0.32);}
    .toast.err{border-color: rgba(255,95,109,0.32);}
    .hint{font-size: 12px;opacity: 0.78;line-height: 1.25rem;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Savings Vault</h1>
          <div class="sub muted">Cardano Preprod · Lucid · Plutus V2</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill">
          <div style="display:flex;flex-direction:column;gap:4px">
            <div class="muted" style="font-size:12px">Wallet</div>
            <div id="walletAddr" class="mono" style="font-size:12px">—</div>
          </div>
        </div>

        <div class="pill">
          <div style="display:flex;flex-direction:column;gap:4px">
            <div class="muted" style="font-size:12px">Balance</div>
            <div id="walletBal" class="mono" style="font-size:12px">—</div>
          </div>
        </div>

        <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
        <button id="refreshBtn" class="btn btn-ghost" disabled>Refresh</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h2>Create Vault</h2>

        <div class="grid2">
          <div>
            <label>Target (ADA)</label>
            <input id="targetAda" placeholder="e.g. 50" inputmode="decimal" />
          </div>
          <div>
            <label>Initial Deposit (ADA)</label>
            <input id="initialAda" placeholder="e.g. 5 (optional)" inputmode="decimal" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Description (off-chain only)</label>
          <textarea id="desc" placeholder="What are you saving for?"></textarea>
        </div>

        <div class="row" style="margin-top:10px; justify-content:space-between; flex-wrap:wrap">
          <button id="createBtn" class="btn btn-primary" disabled>Create Vault</button>
          <div class="hint" style="max-width: 560px">After submit, we auto-sync until your wallet/provider updates UTxOs.</div>
        </div>
      </section>

      <section class="card">
        <div class="vaults-head">
          <h2 style="margin:0">Your Vaults</h2>
          <span id="vaultCount" class="tag gold">0</span>
        </div>

        <div id="vaultList" class="vault-list"></div>
        <div id="emptyState" class="hint" style="margin-top:10px; display:none">
          No vaults found yet.
        </div>
      </section>
    </main>
  </div>

  <div class="toast-wrap" id="toasts"></div>

  <script type="module">
    import {
      connectWallet,
      refreshAll,
      waitForVaults,
      waitForVaultById,
      createVault,
      depositToVault,
      withdrawVault,
      deleteVault,
      shortenId,
      setDescription,
      syncUntilChanged
    } from "./lucid.js";

    const $ = (id) => document.getElementById(id);

    const connectBtn = $("connectBtn");
    const refreshBtn = $("refreshBtn");
    const createBtn  = $("createBtn");

    const walletAddr = $("walletAddr");
    const walletBal  = $("walletBal");

    const targetAda  = $("targetAda");
    const initialAda = $("initialAda");
    const desc       = $("desc");

    const vaultList  = $("vaultList");
    const vaultCount = $("vaultCount");
    const emptyState = $("emptyState");

    let connected = false;
    let busy = false;

    function toast(type, title, msg, ms = 8000){
      const wrap = $("toasts");
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      const shown = String(msg || "").slice(0, 2000);
      el.innerHTML = `<div class="t-title">${title}</div><div class="t-msg">${shown}</div>`;
      wrap.appendChild(el);
      setTimeout(() => el.remove(), ms);
    }

    function setBusy(on){
      busy = on;
      connectBtn.disabled = on;
      refreshBtn.disabled = on || !connected;
      createBtn.disabled  = on || !connected;
    }

    function setConnectedUI(){
      connectBtn.textContent = "Wallet connected";
      connectBtn.classList.add("connected-pop");
      setTimeout(() => connectBtn.classList.remove("connected-pop"), 800);
    }

    function copyText(text){
      navigator.clipboard.writeText(text).then(
        () => toast("ok", "Copied", "Copied to clipboard."),
        () => toast("err", "Copy failed", "Could not copy.")
      );
    }

    function num(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

    function fingerprint(vaults){
      return (vaults || [])
        .map(v => `${v.vIdHex}:${v.depositedLovelace}:${v.targetLovelace}:${v.txHash}:${v.outputIndex}`)
        .sort()
        .join("|");
    }

    async function applyUI(res){
      walletAddr.textContent = res.walletAddress || "—";
      walletBal.textContent  = res.balanceAda ? `${res.balanceAda} ADA` : "—";
      renderVaults(res.vaults || []);
    }

    async function postTxSync(prevState){
      toast("ok", "Syncing", "Waiting for wallet/provider to reflect the new UTxOs…", 5000);
      return await syncUntilChanged({
        prevBalanceAda: prevState?.balanceAda ?? null,
        prevVaultFingerprint: prevState?.fp ?? null,
        tries: 14,
        delayMs: 2500
      });
    }

    async function smartRefresh(){
      const first = await refreshAll();
      if ((first.vaults || []).length > 0) return first;

      toast("ok", "Refreshing", "Waiting for Blockfrost indexing…", 5000);
      return await waitForVaults({ tries: 12, delayMs: 2500 });
    }

    function renderVaults(vaults){
      vaultList.innerHTML = "";
      vaultCount.textContent = String(vaults.length);
      emptyState.style.display = vaults.length ? "none" : "block";

      for (const v of vaults){
        const target = num(v.targetAda);
        const dep = num(v.depositedAda);
        const pct = target <= 0 ? (dep > 0 ? 100 : 0) : Math.min(100, Math.floor((dep/target)*100));

        const card = document.createElement("div");
        card.className = "vault";
        card.innerHTML = `
          <div class="vault-top">
            <div>
              <div class="row" style="gap:8px; flex-wrap:wrap">
                <span class="tag gold">Vault</span>
                <span class="mono copy" data-copy="${v.vIdHex}" title="Click to copy">${shortenId(v.vIdHex)}</span>
              </div>
              <div class="kpi">
                <div><span class="muted">Target:</span> <span class="mono">${v.targetAda}</span> ADA</div>
                <div><span class="muted">Deposited:</span> <span class="mono">${v.depositedAda}</span> ADA</div>
              </div>
            </div>
            <div class="tag">Progress ${pct}%</div>
          </div>

          <div class="progress"><div class="bar" style="width:${pct}%"></div></div>

          <div style="margin-top:10px">
            <label>Description (off-chain)</label>
            <input class="descInput" value="${(v.description||"").replaceAll('"','&quot;')}" placeholder="Add a note…" />
          </div>

          <div class="vault-actions">
            <input class="amtInput" placeholder="Amount (ADA)" inputmode="decimal" style="max-width:160px" />
            <button class="btn mini btn-primary depBtn">Deposit</button>
            <button class="btn mini btn-ghost wdBtn">Withdraw</button>
            <button class="btn mini btn-danger delBtn">Delete</button>
          </div>

          <div class="hint" style="margin-top:8px">
            Delete is off-chain archive only (no Delete redeemer in validator).
          </div>
        `;

        card.querySelector("[data-copy]").addEventListener("click", (e) => {
          copyText(e.target.getAttribute("data-copy"));
        });

        const descInput = card.querySelector(".descInput");
        descInput.addEventListener("change", () => {
          setDescription(v.vIdHex, descInput.value);
          toast("ok", "Saved", "Description saved locally.");
        });

        const amtInput = card.querySelector(".amtInput");
        const depBtn = card.querySelector(".depBtn");
        const wdBtn  = card.querySelector(".wdBtn");
        const delBtn = card.querySelector(".delBtn");

        if (v.depositedLovelace !== "0") {
          delBtn.disabled = true;
          delBtn.title = "Vault must be empty (0 deposited) to delete/archive.";
        }

        depBtn.addEventListener("click", async () => {
          if (busy) return;
          const amount = amtInput.value.trim();
          if (!amount) return toast("err", "Missing amount", "Enter deposit amount in ADA.");

          try{
            setBusy(true);

            const before = await refreshAll();
            const prev = { balanceAda: before.balanceAda, fp: fingerprint(before.vaults) };

            const res = await depositToVault({ vaultIdHex: v.vIdHex, amountAda: amount });
            toast("ok", "Deposit submitted", `Tx: ${res.txHash}`);

            const synced = await postTxSync(prev);
            await applyUI(synced);
          } catch(e){
            console.error(e);
            toast("err", "Deposit failed", e?.message || String(e));
          } finally{
            setBusy(false);
          }
        });

        wdBtn.addEventListener("click", async () => {
          if (busy) return;
          try{
            setBusy(true);

            const before = await refreshAll();
            const prev = { balanceAda: before.balanceAda, fp: fingerprint(before.vaults) };

            const res = await withdrawVault({ vaultIdHex: v.vIdHex });
            toast("ok", "Withdraw submitted", `Tx: ${res.txHash}`);

            const synced = await postTxSync(prev);
            await applyUI(synced);
          } catch(e){
            console.error(e);
            toast("err", "Withdraw failed", e?.message || String(e));
          } finally{
            setBusy(false);
          }
        });

        delBtn.addEventListener("click", async () => {
          if (busy) return;
          try{
            setBusy(true);
            await deleteVault({ vaultIdHex: v.vIdHex });
            toast("ok", "Archived", "Vault hidden locally.");
            const res = await smartRefresh();
            await applyUI(res);
          } catch(e){
            console.error(e);
            toast("err", "Delete failed", e?.message || String(e));
          } finally{
            setBusy(false);
          }
        });

        vaultList.appendChild(card);
      }
    }

    connectBtn.addEventListener("click", async () => {
      if (busy) return;
      try{
        setBusy(true);
        const info = await connectWallet();
        connected = true;
        walletAddr.textContent = info.walletAddress;
        walletBal.textContent  = `${info.balanceAda} ADA`;
        setConnectedUI();
        refreshBtn.disabled = false;
        createBtn.disabled = false;
        toast("ok", "Connected", `Wallet: ${info.walletName.toUpperCase()}`);

        const res = await smartRefresh();
        await applyUI(res);
      } catch(e){
        console.error(e);
        toast("err", "Connect failed", e?.message || String(e));
      } finally{
        setBusy(false);
      }
    });

    refreshBtn.addEventListener("click", async () => {
      if (!connected || busy) return;
      setBusy(true);
      try{
        const first = await refreshAll();
        await applyUI(first);

        const synced = await postTxSync({ balanceAda: first.balanceAda, fp: fingerprint(first.vaults) });
        await applyUI(synced);
      } catch(e){
        console.error(e);
        toast("err", "Refresh failed", e?.message || String(e));
      } finally{
        setBusy(false);
      }
    });

    createBtn.addEventListener("click", async () => {
      if (!connected || busy) return;

      const t = targetAda.value.trim();
      const i = initialAda.value.trim() || "0";
      const d = desc.value.trim();
      if (!t) return toast("err", "Missing target", "Enter a target amount in ADA.");

      try{
        setBusy(true);

        const before = await refreshAll();
        const prev = { balanceAda: before.balanceAda, fp: fingerprint(before.vaults) };

        const res = await createVault({ targetAda: t, initialDepositAda: i, description: d });
        toast("ok", "Vault created", `Tx: ${res.txHash}\nWaiting for indexing…`);

        targetAda.value = ""; initialAda.value = ""; desc.value = "";

        const appeared = await waitForVaultById(res.vIdHex, { tries: 18, delayMs: 2500 });
        await applyUI(appeared);

        const synced = await postTxSync(prev);
        await applyUI(synced);
      } catch(e){
        console.error(e);
        toast("err", "Create failed", e?.message || String(e));
      } finally{
        setBusy(false);
      }
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Savings Vault — Preprod</title>
    <style>
      :root{
        --bg:#0f0b08;
        --panel:#17100b;
        --panel2:#1f160f;
        --text:#ffffff;
        --muted:rgba(255,255,255,.72);
        --muted2:rgba(255,255,255,.55);
        --line:rgba(255,255,255,.12);
        --shadow:0 20px 60px rgba(0,0,0,.35);

        --accent:#c47a3a;          /* burnt chocolate */
        --accent2:#ffead6;
        --good:#3ddc84;
        --bad:#ff4d4d;
        --warn:#ffcc66;

        --radius:18px;
        --radius2:14px;
        --pad:18px;
        --pad2:14px;

        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      }

      [data-theme="light"]{
        --bg:#ffffff;
        --panel:#fff7f0;
        --panel2:#ffffff;
        --text:#1b120c;
        --muted:rgba(27,18,12,.72);
        --muted2:rgba(27,18,12,.55);
        --line:rgba(27,18,12,.12);
        --shadow:0 18px 55px rgba(0,0,0,.12);

        --accent:#8b4513;          /* burnt chocolate (deeper) */
        --accent2:#fff2e6;
      }

      *{ box-sizing:border-box; }
      html,body{ height:100%; }
      body{
        margin:0;
        font-family:var(--sans);
        background:
          radial-gradient(1200px 700px at 20% -10%, rgba(196,122,58,.25), transparent 55%),
          radial-gradient(900px 600px at 90% 0%, rgba(255,234,214,.18), transparent 55%),
          radial-gradient(1100px 700px at 70% 120%, rgba(196,122,58,.16), transparent 60%),
          var(--bg);
        color:var(--text);
      }

      a{ color:inherit; text-decoration:none; }
      button,input,select,textarea{ font-family:inherit; }

      .app{
        min-height:100%;
        display:flex;
        flex-direction:column;
      }

      header{
        position:sticky;
        top:0;
        z-index:10;
        backdrop-filter: blur(14px);
        background: linear-gradient(to bottom, rgba(0,0,0,.28), rgba(0,0,0,.05));
        border-bottom:1px solid var(--line);
      }

      [data-theme="light"] header{
        background: linear-gradient(to bottom, rgba(255,255,255,.78), rgba(255,255,255,.35));
      }

      .wrap{
        width:min(1180px, 92vw);
        margin:0 auto;
      }

      .topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:14px 0;
        gap:14px;
      }

      .brand{
        display:flex;
        align-items:center;
        gap:12px;
        min-width:220px;
      }

      .logo{
        width:40px;height:40px;border-radius:14px;
        background:
          radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
          radial-gradient(26px 26px at 70% 70%, rgba(0,0,0,.25), transparent 60%),
          linear-gradient(135deg, var(--accent), rgba(255,234,214,.4));
        box-shadow: 0 14px 35px rgba(0,0,0,.25);
      }

      .brand h1{
        margin:0;
        font-size:14px;
        letter-spacing:.4px;
        font-weight:750;
        line-height:1.05;
      }
      .brand .sub{
        margin:2px 0 0;
        font-size:12px;
        color:var(--muted2);
      }

      .actions{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }

      .pill{
        border:1px solid var(--line);
        background: rgba(255,255,255,.05);
        color:var(--text);
        border-radius:999px;
        padding:10px 12px;
        display:flex;
        align-items:center;
        gap:10px;
        box-shadow: 0 10px 30px rgba(0,0,0,.12);
      }

      [data-theme="light"] .pill{ background: rgba(255,255,255,.75); }

      .pill .label{
        font-size:12px;
        color:var(--muted2);
      }
      .pill .value{
        font-size:12px;
        font-family:var(--mono);
        max-width:360px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }

      .btn{
        border:1px solid var(--line);
        background: rgba(255,255,255,.06);
        color:var(--text);
        border-radius:12px;
        padding:10px 12px;
        cursor:pointer;
        transition: transform .06s ease, background .15s ease, border-color .15s ease;
      }
      .btn:hover{ background: rgba(255,255,255,.10); }
      .btn:active{ transform: translateY(1px); }

      .btn.primary{
        border-color: rgba(196,122,58,.55);
        background: linear-gradient(135deg, rgba(196,122,58,.95), rgba(255,234,214,.22));
        color: #1a110a;
        font-weight:750;
      }
      [data-theme="light"] .btn.primary{ color:#1a110a; }

      .btn.danger{
        border-color: rgba(255,77,77,.45);
        background: rgba(255,77,77,.12);
      }
      .btn.good{
        border-color: rgba(61,220,132,.45);
        background: rgba(61,220,132,.10);
      }

      .btn.small{ padding:8px 10px; border-radius:11px; font-size:13px; }
      .btn.icon{
        padding:10px 11px;
        border-radius:12px;
        display:inline-flex;
        align-items:center;
        gap:8px;
      }

      .grid{
        display:grid;
        grid-template-columns: 1.2fr .8fr;
        gap:18px;
        padding:18px 0 26px;
      }

      @media (max-width: 980px){
        .grid{ grid-template-columns:1fr; }
      }

      .card{
        border:1px solid var(--line);
        border-radius: var(--radius);
        background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
        box-shadow: var(--shadow);
        overflow:hidden;
      }
      [data-theme="light"] .card{
        background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.7));
      }

      .card .hd{
        padding:16px var(--pad);
        border-bottom:1px solid var(--line);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
      }
      .card .hd h2{
        margin:0;
        font-size:14px;
        letter-spacing:.3px;
        font-weight:760;
      }
      .card .hd .hint{
        font-size:12px;
        color:var(--muted2);
      }

      .card .bd{ padding: var(--pad); }

      .row{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:12px;
      }
      @media (max-width: 640px){
        .row{ grid-template-columns: 1fr; }
      }

      label{
        display:block;
        font-size:12px;
        color:var(--muted2);
        margin:0 0 6px;
      }

      input,select,textarea{
        width:100%;
        border:1px solid var(--line);
        background: rgba(0,0,0,.18);
        color:var(--text);
        border-radius: 12px;
        padding: 11px 12px;
        outline:none;
      }
      [data-theme="light"] input,
      [data-theme="light"] select,
      [data-theme="light"] textarea{
        background: rgba(255,255,255,.9);
        color: var(--text);
      }
      textarea{ min-height:90px; resize:vertical; font-family: var(--mono); font-size: 12px; }

      .inline{
        display:flex;
        align-items:flex-end;
        gap:10px;
        flex-wrap:wrap;
      }
      .inline > *{ flex:1; min-width: 160px; }
      .inline .btn{ flex:0 0 auto; }

      .sep{
        height:1px;
        background: var(--line);
        margin:14px 0;
      }

      .statline{
        display:flex;
        gap:12px;
        flex-wrap:wrap;
      }
      .stat{
        padding:10px 12px;
        border:1px solid var(--line);
        border-radius: 14px;
        background: rgba(255,255,255,.05);
        min-width: 220px;
        flex: 1 1 220px;
      }
      [data-theme="light"] .stat{ background: rgba(255,255,255,.75); }

      .stat .k{ font-size:12px; color:var(--muted2); }
      .stat .v{
        margin-top:4px;
        font-family:var(--mono);
        font-size:12px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      .table{
        width:100%;
        border-collapse:separate;
        border-spacing:0;
        overflow:hidden;
        border:1px solid var(--line);
        border-radius: 16px;
      }
      .table th, .table td{
        padding:12px 12px;
        border-bottom:1px solid var(--line);
        font-size:12px;
        text-align:left;
        vertical-align:top;
      }
      .table th{
        font-size:12px;
        color:var(--muted2);
        font-weight:700;
        background: rgba(255,255,255,.06);
      }
      [data-theme="light"] .table th{ background: rgba(0,0,0,.03); }
      .table tr:last-child td{ border-bottom:none; }

      .mono{ font-family:var(--mono); }
      .muted{ color:var(--muted2); }
      .badge{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid var(--line);
        background: rgba(255,255,255,.05);
        font-size:12px;
      }
      [data-theme="light"] .badge{ background: rgba(255,255,255,.7); }

      .badge .dot{
        width:8px;height:8px;border-radius:99px;
        background: var(--accent);
        box-shadow: 0 0 0 4px rgba(196,122,58,.15);
      }

      .toast{
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 16px;
        z-index: 99;
        width: min(960px, 92vw);
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(14px);
        box-shadow: var(--shadow);
        display:none;
        overflow:hidden;
      }
      [data-theme="light"] .toast{ background: rgba(255,255,255,.85); }
      .toast .bar{
        height:4px;
        background: linear-gradient(90deg, var(--accent), rgba(255,234,214,.7));
      }
      .toast .msg{
        padding: 12px 14px;
        font-size: 12px;
        white-space: pre-wrap;
        line-height:1.35;
      }

      .overlay{
        position: fixed;
        inset:0;
        background: rgba(0,0,0,.55);
        display:none;
        align-items:center;
        justify-content:center;
        z-index: 100;
      }
      .overlay .box{
        width:min(760px, 92vw);
        border:1px solid var(--line);
        border-radius: 18px;
        background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
        box-shadow: var(--shadow);
        overflow:hidden;
      }
      [data-theme="light"] .overlay .box{
        background: rgba(255,255,255,.92);
      }
      .overlay .box .hd{
        padding:14px 16px;
        border-bottom:1px solid var(--line);
        display:flex;
        align-items:center;
        justify-content:space-between;
      }
      .overlay .box .hd .t{ font-weight:800; font-size:13px; letter-spacing:.2px; }
      .overlay .box .bd{
        padding: 14px 16px;
        font-size: 12px;
        white-space: pre-wrap;
        line-height:1.35;
        max-height: 60vh;
        overflow:auto;
        font-family: var(--mono);
      }

      .kpi{
        display:flex;
        align-items:center;
        gap:10px;
      }

      .kpi .big{
        font-size:13px;
        font-weight:850;
        letter-spacing:.2px;
      }

      .foot{
        padding: 14px 0 28px;
        color: var(--muted2);
        font-size: 12px;
      }

      .right-actions{
        display:flex;
        gap:10px;
        align-items:center;
        flex-wrap:wrap;
        justify-content:flex-end;
      }
    </style>
  </head>

  <body>
    <div class="app" id="app" data-theme="dark">
      <header>
        <div class="wrap">
          <div class="topbar">
            <div class="brand">
              <div class="logo" aria-hidden="true"></div>
              <div>
                <h1>Savings Vault</h1>
                <div class="sub">Cardano Preprod • Lucid.js</div>
              </div>
            </div>

            <div class="actions">
              <div class="pill" title="Network">
                <div class="label">Network</div>
                <div class="value" id="netPill">—</div>
              </div>

              <button class="btn icon" id="themeBtn" type="button" title="Toggle theme">
                <span class="mono">⟲</span>
                <span>Theme</span>
              </button>

              <button class="btn primary icon" id="refreshBtn" type="button">
                <span class="mono">⟳</span>
                <span>Refresh</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      <main class="wrap">
        <div class="grid">
          <!-- LEFT: VAULTS -->
          <section class="card">
            <div class="hd">
              <div class="kpi">
                <span class="badge"><span class="dot"></span><span id="statusLabel">Not connected</span></span>
                <span class="muted" id="statusSub">Initialize provider, then connect wallet.</span>
              </div>
              <div class="right-actions">
                <button class="btn small good" id="connectBtn" type="button">Connect Wallet</button>
                <button class="btn small danger" id="disconnectBtn" type="button" disabled>Disconnect</button>
              </div>
            </div>

            <div class="bd">
              <div class="statline">
                <div class="stat">
                  <div class="k">Script Address</div>
                  <div class="v" id="scriptAddr">—</div>
                </div>
                <div class="stat">
                  <div class="k">Wallet Address</div>
                  <div class="v" id="walletAddr">—</div>
                </div>
                <div class="stat">
                  <div class="k">Balance (ADA)</div>
                  <div class="v" id="walletBal">—</div>
                </div>
              </div>

              <div class="sep"></div>

              <div class="inline">
                <div>
                  <label>Quick actions</label>
                  <div class="badge" title="Deposit fee schedule is computed off-chain (requiredDepositFeeLovel)">
                    <span class="dot"></span>
                    <span class="mono">Fees + Auto Sync enabled</span>
                  </div>
                </div>
                <button class="btn" id="viewKeyBtn" type="button">Show Stored Blockfrost Key</button>
              </div>

              <div class="sep"></div>

              <div class="inline" style="align-items:flex-end;">
                <div>
                  <label>Find vault by UTxO</label>
                  <input id="findTxHash" placeholder="txHash" class="mono" />
                </div>
                <div>
                  <label>&nbsp;</label>
                  <input id="findIndex" placeholder="outputIndex" inputmode="numeric" />
                </div>
                <button class="btn" id="findBtn" type="button">Find</button>
              </div>

              <div class="sep"></div>

              <div style="overflow:auto;">
                <table class="table" id="vaultTable">
                  <thead>
                    <tr>
                      <th style="width:26%;">Vault UTxO</th>
                      <th style="width:18%;">Current (ADA)</th>
                      <th style="width:18%;">Target (ADA)</th>
                      <th style="width:18%;">Owner / Beneficiary</th>
                      <th style="width:20%;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vaultTbody">
                    <tr><td colspan="5" class="muted">No vaults loaded yet.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- RIGHT: CONFIG + CREATE -->
          <aside class="card">
            <div class="hd">
              <h2>Provider & Create Vault</h2>
              <div class="hint">Blockfrost key is stored locally</div>
            </div>
            <div class="bd">
              <div class="row">
                <div>
                  <label>Blockfrost project_id (Preprod)</label>
                  <input id="bfKey" placeholder="preprod..." class="mono" />
                  <div class="muted" style="margin-top:6px;font-size:12px;">
                    This is the space to paste your Blockfrost key, then click <span class="mono">Initialize</span>.
                  </div>
                </div>
                <div>
                  <label>Wallet (optional)</label>
                  <select id="walletSelect">
                    <option value="">Auto-detect</option>
                    <option value="lace">lace</option>
                    <option value="eternl">eternl</option>
                    <option value="nami">nami</option>
                    <option value="flint">flint</option>
                    <option value="typhon">typhon</option>
                    <option value="gerowallet">gerowallet</option>
                    <option value="yoroi">yoroi</option>
                  </select>
                </div>
              </div>

              <div class="inline" style="margin-top:12px;">
                <button class="btn primary" id="initBtn" type="button">Initialize</button>
                <button class="btn" id="loadStoredBtn" type="button">Load Stored Key</button>
                <button class="btn danger" id="clearStoredBtn" type="button">Clear Stored Key</button>
              </div>

              <div class="sep"></div>

              <div class="row">
                <div>
                  <label>Beneficiary PKH (hex, optional)</label>
                  <input id="beneficiary" placeholder="leave empty to pay owner" class="mono" />
                </div>
                <div>
                  <label>Mode / Policy</label>
                  <div class="row" style="grid-template-columns: 1fr 1fr;">
                    <input id="mode" placeholder="mode (number)" inputmode="numeric" />
                    <input id="policy" placeholder="policy (number)" inputmode="numeric" />
                  </div>
                </div>

                <div>
                  <label>Target (ADA)</label>
                  <input id="targetAda" placeholder="e.g. 100" />
                </div>
                <div>
                  <label>Unlock time (ms since epoch)</label>
                  <input id="unlockMs" placeholder="0 for none" inputmode="numeric" class="mono" />
                </div>

                <div>
                  <label>Initial deposit (ADA)</label>
                  <input id="initialAda" placeholder="e.g. 5" />
                </div>
                <div>
                  <label>&nbsp;</label>
                  <button class="btn primary" id="createBtn" type="button">Create Vault</button>
                </div>
              </div>

              <div class="sep"></div>

              <label>Logs</label>
              <textarea id="log" readonly spellcheck="false"></textarea>

              <div class="foot">
                Tip: If you get “Missing Blockfrost project_id”, initialize first (key stored under
                <span class="mono">sv_blockfrost_preprod_project_id</span>).
              </div>
            </div>
          </aside>
        </div>
      </main>

      <div class="toast" id="toast">
        <div class="bar"></div>
        <div class="msg" id="toastMsg"></div>
      </div>

      <div class="overlay" id="overlay">
        <div class="box">
          <div class="hd">
            <div class="t" id="overlayTitle">Details</div>
            <button class="btn small" id="overlayClose" type="button">Close</button>
          </div>
          <div class="bd" id="overlayBody"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import * as offchain from "./lucid.js";

      // ---------- DOM ----------
      const $ = (id) => document.getElementById(id);

      const app = $("app");
      const netPill = $("netPill");

      const statusLabel = $("statusLabel");
      const statusSub = $("statusSub");

      const scriptAddr = $("scriptAddr");
      const walletAddr = $("walletAddr");
      const walletBal = $("walletBal");

      const bfKey = $("bfKey");
      const initBtn = $("initBtn");
      const loadStoredBtn = $("loadStoredBtn");
      const clearStoredBtn = $("clearStoredBtn");
      const viewKeyBtn = $("viewKeyBtn");

      const connectBtn = $("connectBtn");
      const disconnectBtn = $("disconnectBtn");
      const walletSelect = $("walletSelect");

      const refreshBtn = $("refreshBtn");
      const themeBtn = $("themeBtn");

      const vaultTbody = $("vaultTbody");
      const findTxHash = $("findTxHash");
      const findIndex = $("findIndex");
      const findBtn = $("findBtn");

      const beneficiary = $("beneficiary");
      const mode = $("mode");
      const policy = $("policy");
      const targetAda = $("targetAda");
      const unlockMs = $("unlockMs");
      const initialAda = $("initialAda");
      const createBtn = $("createBtn");

      const logEl = $("log");

      const toast = $("toast");
      const toastMsg = $("toastMsg");

      const overlay = $("overlay");
      const overlayTitle = $("overlayTitle");
      const overlayBody = $("overlayBody");
      const overlayClose = $("overlayClose");

      // ---------- helpers ----------
      const LS_THEME = "sv_ui_theme";
      const LS_BF = "sv_blockfrost_preprod_project_id";

      function now() {
        const d = new Date();
        return d.toLocaleString();
      }

      function log(line) {
        const s = `[${now()}] ${line}`;
        logEl.value = (logEl.value ? logEl.value + "\n" : "") + s;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function toastify(msg) {
        toastMsg.textContent = msg;
        toast.style.display = "block";
        clearTimeout(toast._t);
        toast._t = setTimeout(() => {
          toast.style.display = "none";
        }, 5200);
      }

      function showOverlay(title, body) {
        overlayTitle.textContent = title;
        overlayBody.textContent = body;
        overlay.style.display = "flex";
      }

      function hideOverlay() {
        overlay.style.display = "none";
      }

      function setStatus(main, sub = "") {
        statusLabel.textContent = main;
        statusSub.textContent = sub || "";
      }

      function shorten(s, left = 10, right = 8) {
        const x = String(s || "");
        if (x.length <= left + right + 3) return x;
        return `${x.slice(0, left)}...${x.slice(-right)}`;
      }

      function getStoredKey() {
        try { return (localStorage.getItem(LS_BF) || "").trim(); } catch { return ""; }
      }

      function setStoredKey(k) {
        try { localStorage.setItem(LS_BF, String(k || "").trim()); } catch {}
      }

      function clearStoredKey() {
        try { localStorage.removeItem(LS_BF); } catch {}
      }

      function disableWhile(btn, fn) {
        return async () => {
          const prev = btn.disabled;
          btn.disabled = true;
          try { await fn(); }
          finally { btn.disabled = prev; }
        };
      }

      // ---------- state ----------
      let initialized = false;
      let connected = false;
      let lastVaults = [];

      // ---------- theme ----------
      function applyTheme(theme) {
        app.setAttribute("data-theme", theme);
        try { localStorage.setItem(LS_THEME, theme); } catch {}
      }
      (function initTheme(){
        let t = "dark";
        try { t = localStorage.getItem(LS_THEME) || "dark"; } catch {}
        applyTheme(t);
      })();

      themeBtn.onclick = () => {
        const cur = app.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
      };

      // ---------- network pill ----------
      netPill.textContent = offchain.NETWORK || "—";

      // ---------- render vaults ----------
      function renderVaults(vaults) {
        lastVaults = vaults || [];

        if (!vaults || vaults.length === 0) {
          vaultTbody.innerHTML = `<tr><td colspan="5" class="muted">No vault UTxOs found at the script address.</td></tr>`;
          return;
        }

        const rows = vaults.map((v) => {
          const id = `${v.txHash}#${v.outputIndex}`;
          const owner = shorten(v.ownerPkhHex, 10, 10);
          const ben = v.beneficiaryPkhHex ? shorten(v.beneficiaryPkhHex, 10, 10) : "—";
          const cur = v.currentAda ?? "—";
          const tgt = v.targetAda ?? "—";

          return `
            <tr>
              <td>
                <div class="mono" title="${id}">${shorten(v.txHash, 14, 10)}#${v.outputIndex}</div>
                <div class="muted mono" style="margin-top:6px;">unlock: ${v.unlockTime}</div>
              </td>
              <td class="mono">${cur}</td>
              <td class="mono">${tgt}</td>
              <td>
                <div class="mono">owner: ${owner}</div>
                <div class="muted mono" style="margin-top:6px;">ben: ${ben}</div>
              </td>
              <td>
                <div class="inline" style="gap:8px; align-items:center;">
                  <button class="btn small" data-act="deposit" data-id="${id}">Deposit</button>
                  <button class="btn small good" data-act="withdraw" data-id="${id}">Withdraw</button>
                  <button class="btn small danger" data-act="force" data-id="${id}">Force</button>
                  <button class="btn small" data-act="details" data-id="${id}">Details</button>
                </div>
              </td>
            </tr>
          `;
        });

        vaultTbody.innerHTML = rows.join("");

        // bind actions
        vaultTbody.querySelectorAll("button[data-act]").forEach((b) => {
          b.addEventListener("click", async () => {
            const act = b.getAttribute("data-act");
            const id = b.getAttribute("data-id");
            const [txHash, idxStr] = id.split("#");
            const outputIndex = Number(idxStr);

            if (act === "details") {
              const found = lastVaults.find((x) => x.txHash === txHash && Number(x.outputIndex) === outputIndex);
              showOverlay("Vault details", JSON.stringify(found, null, 2));
              return;
            }

            if (!connected) {
              toastify("Connect wallet first.");
              return;
            }

            if (act === "deposit") {
              const amountAda = prompt("Deposit amount (ADA):", "1");
              if (amountAda == null) return;

              await runWithOverlay("Depositing…", async () => {
                const res = await offchain.depositToVault({ txHash, outputIndex, amountAda });
                log(`depositToVault => txHash=${res.txHash} feeAda=${res.feeAda}`);
                toastify(`Deposit submitted: ${res.txHash}\nFee: ${res.feeAda} ADA`);
                await refreshAll();
              });
              return;
            }

            if (act === "withdraw") {
              if (!confirm("Withdraw all funds from this vault?")) return;

              await runWithOverlay("Withdrawing…", async () => {
                const res = await offchain.withdrawVault({ txHash, outputIndex });
                log(`withdrawVault => txHash=${res.txHash} recipient=${res.recipientAddress}`);
                toastify(`Withdraw submitted: ${res.txHash}`);
                await refreshAll();
              });
              return;
            }

            if (act === "force") {
              if (!confirm("Force withdraw applies penalty. Continue?")) return;

              await runWithOverlay("Force withdrawing…", async () => {
                const res = await offchain.forceWithdrawVault({ txHash, outputIndex });
                log(`forceWithdrawVault => txHash=${res.txHash} penaltyAda=${res.penaltyAda}`);
                toastify(`Force withdraw submitted: ${res.txHash}\nPenalty: ${res.penaltyAda} ADA`);
                await refreshAll();
              });
              return;
            }
          });
        });
      }

      // ---------- overlay runner ----------
      async function runWithOverlay(title, fn) {
        showOverlay(title, "Working…");
        try {
          const out = await fn();
          return out;
        } catch (e) {
          const msg = e?.message ? String(e.message) : String(e);
          showOverlay("Error", msg);
          toastify(msg);
          log("ERROR: " + msg);
          throw e;
        } finally {
          // keep overlay open if it's an error; otherwise auto-hide after a moment
          if (overlayTitle.textContent !== "Error") {
            setTimeout(() => hideOverlay(), 700);
          }
        }
      }

      overlayClose.onclick = hideOverlay;
      overlay.addEventListener("click", (ev) => {
        if (ev.target === overlay) hideOverlay();
      });

      // ---------- init / connect ----------
      async function initialize(blockfrostKey) {
        const res = await offchain.initLucid({ blockfrostKey });
        initialized = true;

        scriptAddr.textContent = res.scriptAddress || "—";
        setStatus("Initialized", "Now connect your wallet.");
        log(`initLucid OK => scriptAddress=${res.scriptAddress}`);
        toastify("Initialized. Script address computed.");

        await refreshVaultsOnly();
      }

      async function connect() {
        const walletName = walletSelect.value || "";
        const res = await offchain.connectWallet(walletName);
        connected = true;

        walletAddr.textContent = res.walletAddress || "—";
        walletBal.textContent = res.balanceAda || "—";
        scriptAddr.textContent = res.scriptAddress || scriptAddr.textContent || "—";

        disconnectBtn.disabled = false;
        setStatus(`Connected (${res.walletName})`, "Ready. Create / deposit / withdraw.");
        log(`connectWallet OK => ${res.walletName} pkh=${res.walletPkhHex}`);
        toastify(`Connected: ${res.walletName}`);

        await refreshAll();
      }

      async function disconnect() {
        offchain.disconnectWallet();
        connected = false;

        walletAddr.textContent = "—";
        walletBal.textContent = "—";
        disconnectBtn.disabled = true;

        setStatus("Disconnected", "You can reconnect anytime.");
        log("disconnectWallet OK");
        toastify("Disconnected.");
      }

      // ---------- refresh ----------
      async function refreshWallet() {
        if (!connected) return;
        const st = await offchain.refreshWalletState();
        walletAddr.textContent = st.walletAddress || "—";
        walletBal.textContent = st.balanceAda || "—";
      }

      async function refreshVaultsOnly() {
        if (!initialized) return;
        const vaults = await offchain.listVaults();
        renderVaults(vaults);
      }

      async function refreshAll() {
        if (!initialized) return;
        await refreshWallet().catch(() => {});
        await refreshVaultsOnly().catch(() => {});
      }

      // ---------- buttons ----------
      initBtn.onclick = disableWhile(initBtn, async () => {
        const key = (bfKey.value || "").trim();
        if (!key) {
          toastify("Paste your Blockfrost project_id first.");
          return;
        }
        await runWithOverlay("Initializing…", async () => initialize(key));
      });

      loadStoredBtn.onclick = () => {
        const k = getStoredKey();
        bfKey.value = k;
        toastify(k ? "Loaded stored key into input." : "No stored key found.");
      };

      clearStoredBtn.onclick = () => {
        clearStoredKey();
        bfKey.value = "";
        toastify("Stored key cleared.");
        log("Cleared stored Blockfrost key.");
      };

      viewKeyBtn.onclick = () => {
        const k = getStoredKey();
        showOverlay("Stored Blockfrost key", k ? k : "(none)");
      };

      connectBtn.onclick = disableWhile(connectBtn, async () => {
        if (!initialized) {
          const stored = getStoredKey();
          const keyToUse = (bfKey.value || stored || "").trim();
          if (!keyToUse) {
            toastify("Initialize first: paste Blockfrost key and click Initialize.");
            return;
          }
          await runWithOverlay("Initializing…", async () => initialize(keyToUse));
        }
        await runWithOverlay("Connecting wallet…", async () => connect());
      });

      disconnectBtn.onclick = disableWhile(disconnectBtn, async () => disconnect());

      refreshBtn.onclick = disableWhile(refreshBtn, async () => {
        await runWithOverlay("Refreshing…", async () => refreshAll());
        toastify("Refreshed.");
      });

      // Find vault
      findBtn.onclick = disableWhile(findBtn, async () => {
        if (!initialized) {
          toastify("Initialize first.");
          return;
        }
        const txHash = (findTxHash.value || "").trim();
        const outputIndex = Number((findIndex.value || "").trim());
        if (!txHash || !Number.isFinite(outputIndex)) {
          toastify("Provide txHash and outputIndex.");
          return;
        }
        await runWithOverlay("Finding vault…", async () => {
          const v = await offchain.getVaultById({ txHash, outputIndex });
          if (!v) {
            toastify("Vault not found at script address.");
            showOverlay("Not found", "No matching UTxO found at the script address.");
            return;
          }
          showOverlay("Vault found", JSON.stringify(v, null, 2));
        });
      });

      // Create vault
      createBtn.onclick = disableWhile(createBtn, async () => {
        if (!connected) {
          toastify("Connect wallet first.");
          return;
        }

        const beneficiaryPkhHex = (beneficiary.value || "").trim();
        const m = Number((mode.value || "0").trim() || "0");
        const p = Number((policy.value || "0").trim() || "0");
        const tAda = (targetAda.value || "0").trim();
        const uMs = Number((unlockMs.value || "0").trim() || "0");
        const initAda = (initialAda.value || "0").trim();

        await runWithOverlay("Creating vault…", async () => {
          const res = await offchain.createVault({
            beneficiaryPkhHex,
            mode: m,
            policy: p,
            targetAda: tAda,
            unlockTimeMs: uMs,
            initialDepositAda: initAda,
          });
          log(`createVault => txHash=${res.txHash}`);
          toastify(`Vault created: ${res.txHash}`);
          await refreshAll();
        });
      });

      // ---------- on load: try auto-init ----------
      (async function boot() {
        try {
          setStatus("Not connected", "Paste Blockfrost key and Initialize.");
          const stored = getStoredKey();
          if (stored) {
            bfKey.value = stored;
            log("Found stored Blockfrost key in localStorage.");
            // auto-init for convenience
            await initialize(stored);
          }
        } catch (e) {
          const msg = e?.message ? String(e.message) : String(e);
          log("Boot init failed: " + msg);
        }
      })();
    </script>
  </body>
</html>
